import json
import time
from websocket import WebSocketApp
import threading
import socket
import hmac
import hashlib
from datetime import datetime

class GateWebSocketApp(WebSocketApp):

    def __init__(self, url, **kwargs):
        super(GateWebSocketApp, self).__init__(url, **kwargs)

    def _request(self, channel, event=None, payload=None, auth_required=True):
        data = \
            {"jsonrpc": "2.0",
             "method": "public/subscribe",
             "id": 42,
             "params": {
                 "channels": ["quote.BTC-PERPETUAL"]}
             }

        data = json.dumps(data)
        print('request', data)
        self.send(data)

    def subscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "subscribe", payload, auth_required)

    def unsubscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "unsubscribe", payload, auth_required)


def on_message(ws, message):
    print(message)



def on_open(ws):
    print('Connected')
    ws.subscribe("quote.BTC-PERPETUAL", False)


class GateWebSocketApp1(WebSocketApp):

    def __init__(self, url, **kwargs):
        super(GateWebSocketApp1, self).__init__(url, **kwargs)


    def _request1(self, channel, event=None, payload=None, auth_required=True):
        current_time = int(time.time())
        data =  \
            {"jsonrpc": "2.0",
             "method": "public/subscribe",
             "id": 42,
             "params": {
                 "channels": ["book.BTC-PERPETUAL.raw"]}
             }

        data = json.dumps(data)
        print('request', data)
        self.send(data)

    def subscribe(self, channel, payload=None, auth_required=True):
        self._request1(channel, "subscribe", payload, auth_required)

    def unsubscribe(self, channel, payload=None, auth_required=True):
        self._request1(channel, "unsubscribe", payload, auth_required)


def on_message1(ws, message):
    print(message)


def on_open1(ws):
    print('Connected')
    ws.subscribe("book.BTC-PERPETUAL.raw", False)

class GateWebSocketApp2(WebSocketApp):

    def __init__(self, url, **kwargs):
        super(GateWebSocketApp2, self).__init__(url, **kwargs)

    def _request(self, channel, event=None, payload=None, auth_required=True):
        data = \
            {"jsonrpc": "2.0",
             "method": "public/subscribe",
             "id": 42,
             "params": {
                 "channels": ["trades.BTC-PERPETUAL.raw"]}
             }

        data = json.dumps(data)
        print('request', data)
        self.send(data)

    def subscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "subscribe", payload, auth_required)

    def unsubscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "unsubscribe", payload, auth_required)


def on_message2(ws, message):
    print(message)


def on_open2(ws):
    print('Connected')
    ws.subscribe("trades.BTC-PERPETUAL.raw", False)


class GateWebSocketApp_auth(WebSocketApp):
    IP_ADDRESS = "192.168.100.5"                      #BINDED IP
    PORT = 54893                                      #PORT

    def __init__(self, url, **kwargs):
        super(GateWebSocketApp_auth, self).__init__(url, **kwargs)

    def _request(self, channel, event=None, payload=None, auth_required=True):

        clientId = "xxx"
        clientSecret = "yyy"
        timestamp = round(datetime.now().timestamp() * 1000)
        nonce = "abcd"
        data = ""
        signature = hmac.new(
            bytes(clientSecret, "latin-1"),
            msg=bytes('{}\n{}\n{}'.format(timestamp, nonce, data), "latin-1"),
            digestmod=hashlib.sha256
        ).hexdigest().lower()

        msg = {
            "jsonrpc": "2.0",
            "id": 8748,
            "method": "public/auth",
            "params": {
                "grant_type": "client_signature",
                "client_id": clientId,
                "timestamp": timestamp,
                "signature": signature,
                "nonce": nonce,
                "data": data
            }
        }

        msg = json.dumps(msg)
        print('request', msg)
        self.send(msg)

    def subscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "subscribe", payload, auth_required)

    def unsubscribe(self, channel, payload=None, auth_required=True):
        self._request(channel, "unsubscribe", payload, auth_required)


def on_message_auth(ws, message):
    print(message)


def on_open_auth(ws):
    print('Auth is Ok')
    ws.subscribe(False)


def auth():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind((GateWebSocketApp_auth.IP_ADDRESS, GateWebSocketApp_auth.PORT))
    s.connect((GateWebSocketApp_auth.IP_ADDRESS, GateWebSocketApp_auth.PORT))
    print("Local ip is:",  s.getsockname()[0])

    app = GateWebSocketApp_auth("wss://www.deribit.com/ws/api/v2",
                           on_open=on_open_auth,
                           on_message=on_message_auth)
    app.run_forever(ping_interval=5)


def quote():

    app = GateWebSocketApp("wss://www.deribit.com/ws/api/v2",
                           on_open=on_open,
                           on_message=on_message)
    app.run_forever(ping_interval=5)


def book():

    app = GateWebSocketApp1("wss://www.deribit.com/ws/api/v2",
                           on_open=on_open1,
                           on_message=on_message1)
    app.run_forever(ping_interval=5)


def trades():

    app = GateWebSocketApp2("wss://www.deribit.com/ws/api/v2",
                           on_open=on_open2,
                           on_message=on_message2)
    app.run_forever(ping_interval=5)



if __name__ == "__main__":
    trd0 = threading.Thread(target=auth)
    trd1 = threading.Thread(target=quote)
    trd2 = threading.Thread(target=book)
    trd3 = threading.Thread(target=trades)

    trd0.start()
    trd1.start()
    trd2.start()
    trd3.start()
    
